# Buf Monorepo (Go gRPC) — Article 2

This repository follows the architecture described in the article
**"Hands-on Buf Monorepo for Go gRPC: A Multi-Module Protobuf Architecture"**.

Core ideas:

- **Buf v2 workspace** at the repo root.
- **Three independent protobuf modules** under `proto/`:
    - `common` — shared, low‑churn types.
    - `user` — user domain.
    - `billing` — billing domain.
- **One global generation config** (`buf.gen.yaml`) that outputs Go stubs into `gen/`.

---

## Prerequisites

- Go **1.22+**
- Buf CLI v2  
  Install: https://buf.build/docs/installation

---

## Buf commands (run at repo root)

```bash
buf lint
```
Runs lint across all modules in the workspace.

```bash
buf breaking --against .git#branch=main
```
Checks breaking changes against the `main` branch.

```bash
buf generate
```
Generates Go protobuf + gRPC stubs for all modules into `gen/`.

> Tip: if you want to refresh generated code from scratch, run:
>
> ```bash
> rm -rf gen
> buf generate
> ```

---

## Running the Go example

1. Generate code:

```bash
buf generate
```

2. Download Go dependencies:

```bash
go mod tidy
```

3. Start the server (in one terminal):

```bash
go run ./cmd/server
```

You should see:

- `UserService listening on :50051`
- `BillingService listening on :50052`

4. Run the client (in another terminal):

```bash
go run ./cmd/client
```

Expected output (example):

- `UserService.GetUser => user={...} domain_error=<nil>`
- `BillingService.GetInvoice => invoice={...} domain_error=<nil>`

> Note: `err != nil` in Go indicates a gRPC/transport failure; `response.error` is a domain/business error returned in the payload.

---

## Project layout

```text
buf-monorepo/
  buf.yaml
  buf.gen.yaml
  proto/
    common/v1/...
    user/v1/...
    billing/v1/...
  gen/                 # generated by `buf generate`
  cmd/
    server/
    client/
```

---

## Architecture notes

- Imports are **workspace‑relative** (e.g., `import "v1/error.proto";`), where the imported file is resolved from the exporting module root in the workspace.
- Each domain owns its own module (`proto/*/buf.yaml`) with a `name:` so modules can be published independently to BSR.
- `common/` should remain **small and stable**, as emphasized in the article.

---

## Next steps

This repo is a solid base to add:

- CI pipelines for `buf lint` + `buf breaking` + `buf generate`
- Publishing each module separately to Buf Schema Registry
- Version evolution (v1 → v2) side‑by‑side (covered in Article 3)
